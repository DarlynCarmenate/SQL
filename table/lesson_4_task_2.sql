select [Наименование], [Фамилия], [Макс балл], [Средний балл] from [Направления] n
join (
select [Фамилия], [Балл], [Код направления],
AVG([Балл]) over(partition by [Идентификатор]) as [Средний балл], 
MAX([Балл]) over(partition by [Код направления]) as [Макс балл],
ROW_NUMBER() over(partition by [Код направления], [Балл] order by [Идентификатор]) as rn
from [Студенты]
) s
on s.[Код направления]=n.[Код направления] and [Балл]=[Макс балл]
where rn=1;